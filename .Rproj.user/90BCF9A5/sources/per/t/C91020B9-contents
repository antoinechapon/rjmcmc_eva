library(tidyverse)
library(reshape2)
library(lubridate)
library(rlist)
library(xtable)
library(nloptr)
library(zoo)

library(extRemes)
library(quantreg)


library(hdrcde)

load("minip_surge.Rdata")
load("t_vec.Rdata")

mean_imp <- apply(minip_surge, 1, mean)
mean_imp <- na.approx(mean_imp)

data <- bind_cols(t = t_vec, surge = mean_imp)


# prep NAO csv
temp <- as.POSIXct(
  paste(norm_daily_nao_cdas_z500_19500101_current$year,
        norm_daily_nao_cdas_z500_19500101_current$month,
        norm_daily_nao_cdas_z500_19500101_current$day,
        sep = "-"),
  tz = "UTC", origin = "1970-01-01"
)

data$nao <- norm_daily_nao_cdas_z500_19500101_current$nao_index_cdas[
  which(temp %in% data$t)
]
data$nao <- na.approx(data$nao)


cor.test(data$surge, data$nao)



library(VineCopula)


BiCopSelect(u1 = pobs(data$surge),
            u2 = pobs(data$nao))




load("w62305_12h.Rdata")

wave <- aggregate(w62305_12h$Hs,
                  by = list(
                    day(w62305_12h$date),
                    month(w62305_12h$date),
                    year(w62305_12h$date)
                  ),
                  FUN = max)
t_wave <-  as.POSIXct(
  paste(wave$Group.3,
        wave$Group.2,
        wave$Group.1,
        sep = "-"),
  tz = "UTC", origin = "1970-01-01"
)


t_common <- as.POSIXct(intersect(t_vec, t_wave), tz = "UTC", origin = "1970-01-01")


data2 <- data.frame(
  t = t_common,
  surge = mean_imp[t_vec %in% t_common],
  hs = wave$x[t_wave %in% t_common]
)


cor.test(data2$surge, data2$hs)

cop <- BiCopSelect(u1 = pobs(data2$surge),
                   u2 = pobs(data2$hs))

contour(cop)


# CDE avec cos sin de year en covar
# - permet genere var1 en conction de year
# - get dyncop en fonction de var1 et year
# - get var2 en fonction de dyncop et year
#
# Manière semi-paramétrique de générer des obs en 2D sans casser le cycle annuel
# commu aux deux varialbe.
# A partir de ces valeurs generes B fois, GEV avec block maxima annuel.
# 
# Bien justfier qu'on voulait faire du resampling pour que ça corresponde au cours
# mais makheureursement on a du faire du parametric bootstrap, pour que ce soit
# adapté aux extremes.
# 
# Et ca permet de faire CI en 2D, vu que CI c'est dans le cours
# (en utilisant le truc de Serinaldi ? ou alors suffit de sampler en Volpi Fiori
# dans le resultat du bootstrap pour CI à la Serinaldi ?)


yr_cos <- cos(yday(data2$t) / (365 + leap_year(data2$t)) * 2 * pi)
yr_sin <- sin(yday(data2$t) / (365 + leap_year(data2$t)) * 2 * pi)

marg1 <- cde(x = cbind(yr_cos, yr_sin),
             y = data2$surge)

